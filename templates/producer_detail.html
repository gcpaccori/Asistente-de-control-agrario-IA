{% extends "base.html" %}
{% block content %}
  <h1>Productor #{{ producer.id }}</h1>
  <div class="card">
    <form method="post" action="{{ url_for('admin_producer_update', producer_id=producer.id) }}">
      <div class="small">Teléfono</div>
      <div><strong>{{ producer.phone }}</strong></div>
      <div class="input-row">
        <div>
          <div class="small">Nombre</div>
          <input type="text" name="name" value="{{ producer.name or '' }}" />
        </div>
        <div>
          <div class="small">Zona</div>
          <input type="text" name="zone" value="{{ producer.zone or '' }}" />
        </div>
        <div>
          <div class="small">Zona horaria</div>
          <input type="text" name="timezone" value="{{ producer.timezone or 'America/Lima' }}" />
        </div>
        <div>
          <div class="small">Estado</div>
          <select name="status">
            <option value="activo" {% if producer.status == "activo" %}selected{% endif %}>Activo</option>
            <option value="inactivo" {% if producer.status != "activo" %}selected{% endif %}>Inactivo</option>
          </select>
        </div>
      </div>
      <div class="small">Rol asignado</div>
      <select name="assigned_role">
        <option value="" {% if not producer.assigned_role %}selected{% endif %}>Sin asignar</option>
        <option value="formulario" {% if producer.assigned_role == "formulario" %}selected{% endif %}>formulario</option>
        <option value="consulta" {% if producer.assigned_role == "consulta" %}selected{% endif %}>consulta</option>
        <option value="intervencion" {% if producer.assigned_role == "intervencion" %}selected{% endif %}>intervencion</option>
      </select>
      <div>
        <label>
          <input type="checkbox" name="allowed" {% if producer.allowed %}checked{% endif %} />
          Autorizado para análisis
        </label>
      </div>
      <div>
        <label>
          <input type="checkbox" name="enable_formulario" {% if producer.enable_formulario %}checked{% endif %} />
          Agente formulario
        </label>
        <label>
          <input type="checkbox" name="enable_consulta" {% if producer.enable_consulta %}checked{% endif %} />
          Agente consulta
        </label>
        <label>
          <input type="checkbox" name="enable_intervencion" {% if producer.enable_intervencion %}checked{% endif %} />
          Agente intervención
        </label>
      </div>
      <button class="btn" type="submit">Guardar</button>
    </form>
  </div>

  <div class="card">
    <h2>Plan y tareas</h2>
    <div class="table-actions">
      <a class="btn secondary" href="{{ url_for('admin_producer_tasks', producer_id=producer.id) }}">Ver tareas</a>
      <a class="btn secondary" href="{{ url_for('admin_daily_logs', producer_id=producer.id) }}">Ver bitácora</a>
    </div>
    <form method="post" action="{{ url_for('admin_plan_assign') }}">
      <input type="hidden" name="producer_id" value="{{ producer.id }}" />
      <div class="input-row">
        <div>
          <div class="small">Plantilla</div>
          <select name="template_id">
            {% for template in templates %}
              <option value="{{ template.id }}">{{ template.crop_type }} (ID {{ template.id }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <div class="small">Fecha inicio</div>
          <input type="date" name="start_date" required />
        </div>
      </div>
      <button class="btn" type="submit">Asignar plan al productor</button>
    </form>
  </div>

  <div class="card">
    <h2>Bitácora reciente</h2>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Notas</th>
          <th>Métricas</th>
        </tr>
      </thead>
      <tbody>
        {% for log in daily_logs %}
          <tr>
            <td><a href="{{ url_for('admin_daily_log_detail', log_id=log.id) }}">{{ log.log_date }}</a></td>
            <td>{{ log.log_type_name or "Sin tipo" }}</td>
            <td>{{ log.notes }}</td>
            <td class="small">{{ log.metrics_json }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="muted">Sin registros de bitácora.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>Tareas asignadas</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Tarea</th>
          <th>Estado</th>
          <th>Fecha estimada</th>
          <th>Avance</th>
          <th>Motivo bloqueo</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
          <tr>
            <td>{{ task.order_sequence }}</td>
            <td>{{ task.task_name }}</td>
            <td>{{ task.status }}</td>
            <td>{{ task.estimated_date or "-" }}</td>
            <td>{{ task.progress_pct or 0 }}%</td>
            <td>{{ task.blocker_reason or "-" }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6" class="muted">Sin tareas asignadas.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>Formularios</h2>
    <form method="post" action="{{ url_for('admin_form_create') }}">
      <input type="hidden" name="producer_id" value="{{ producer.id }}" />
      <button class="btn" type="submit">Nuevo formulario</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Estado</th>
          <th>Cultivo</th>
          <th>Síntoma</th>
          <th>Actualizado</th>
        </tr>
      </thead>
      <tbody>
        {% for form in forms %}
          <tr>
            <td><a href="{{ url_for('admin_form_detail', form_id=form.id) }}">{{ form.id }}</a></td>
            <td>{{ form.status }}</td>
            <td>{{ form.cultivo or "-" }}</td>
            <td>{{ form.sintoma or "-" }}</td>
            <td>{{ form.updated_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>Alertas</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nivel</th>
          <th>Motivo</th>
          <th>Estado</th>
          <th>Creada</th>
        </tr>
      </thead>
      <tbody>
        {% for alert in alerts %}
          <tr>
            <td><a href="{{ url_for('admin_alert_detail', alert_id=alert.id) }}">{{ alert.id }}</a></td>
            <td>{{ alert.level }}</td>
            <td>{{ alert.reason }}</td>
            <td>{{ alert.status }}</td>
            <td>{{ alert.created_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2>Últimos mensajes</h2>
    <table>
      <thead>
        <tr>
          <th>Dirección</th>
          <th>Contenido</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for msg in messages %}
          <tr>
            <td>{{ msg.direction }}</td>
            <td>{{ msg.content }}</td>
            <td>{{ msg.created_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
